<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>くじ引き（なんでも鑑定団・左から桁が増える）</title>
  <style>
    body{background-image: url("cyber_background.png");background-size: cover;margin:0;justify-content:center;align-items:center;height:100vh;font-family:"Segoe UI",Meiryo,sans-serif}
    .panel{background-image: url("7.png");background-size: cover;width:100%;text-align: center;padding: 3%; border-radius:12px;box-shadow:0 0 20px #0007}
    .price{font-size:2200%;font-weight:300;letter-spacing:100%;height:500px;margin-bottom:36%;margin-left:24%;color:#FFD700;font-weight: bold;}
    button{margin-top:20px;padding:12px 20px;font-size:20px;border:none;border-radius:8px;background:#ff7043;color:#fff;cursor:pointer}
    .digit{display:inline-block;animation:pop .18s ease-out}
    @keyframes pop{0%{transform:scale(0.2);opacity:0}60%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}
    .chip {
      position: fixed;
      top: -100px;
      pointer-events: none;
      animation: fall linear forwards;
    }

    @keyframes fall {
      from {
        transform: translateY(0) rotate(0deg);
      }
      to {
        transform: translateY(120vh) rotate(360deg);
      }
    }

</style>
</head>
<body>
<div>
  <button id="start">スタート</button>
</div>
  <div class="panel">
    <div class="price"><span id="out">0</span></div>
  </div>
<script>
    const chipImages = [
      "redchip.png",
      "whitechip.png",
      "greenchip.png",
      "blackchip.png"
      // ここに好きな画像を追加
    ];

    function createChip() {
      const chip = document.createElement("img");
      chip.classList.add("chip");

      // 画像をランダム選択
      chip.src = chipImages[Math.floor(Math.random() * chipImages.length)];

      // ランダム横位置
      chip.style.left = Math.random() * window.innerWidth + "px";

      // ランダムサイズ
      const size = 40 + Math.random() * 60;
      chip.style.width = size + "px";

      // ランダム落下速度
      const duration = 2 + Math.random() * 4;
      chip.style.animationDuration = duration + "s";

      // ランダム回転角度
      chip.style.transform = `rotate(${Math.random() * 360}deg)`;

      document.body.appendChild(chip);

      // アニメーション後に削除
      setTimeout(() => {
        chip.remove();
      }, duration * 1000);
    }


const audio_digitfix = new Audio('digitfix.mp3'); // Audio オブジェクト作成
const audio_amountfix = new Audio('amountfix.mp3');
const audio_bgm = new Audio('10s.mp3'); 

//const amounts = [200, 1000, 5000,10000,100000,1000000];
const gachaTable = [
  { item: 1000000, rate: 8 }, 
  { item: 100000, rate: 111 },
  { item: 10000, rate: 4858 }, 
  { item: 5000, rate: 7627 },
  { item: 1000, rate: 9604 },
  { item: 200,  rate: 10000 }, 
];

const out = document.getElementById("out");
const start = document.getElementById("start");
let busy = false;

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function drawGacha(table) {
  // 総レート（100でなくてもOK、合計から自動計算）
  const total = 10000;
  console.log(`ywdebug ${total}`)
  // 0〜totalのランダム値
  const r = Math.random();
  console.log(`ywdebug ${r}`)
  const pick_number = r * total;
  console.log(`ywdebug ${pick_number}`)
  for (const entry of table) {
    if (pick_number < entry.rate) {
      return entry.item;
    }
  }
}

async function animate(target){
  let timerId = null;
  if(busy) return; busy = true; start.disabled = true;
  audio_bgm.play()

  const str = String(target);     // 例: "10000"
  out.innerHTML = "";             // まず空

  // 左から 1桁ずつ追加するだけ（ユーザーの要望通り）
  for(let i=str.length;i>=0;i--){
    await sleep(1300); // 1桁ずつ表示するテンポ
    const span = document.createElement("span");
    span.className = "digit";
    span.textContent = str[i];
    out.prepend(span);
    if (i!=str.length) audio_digitfix.play();
  }


  busy = false;
  start.disabled = false;
  timerId = setInterval(createChip, 100);
  await sleep(3500); 
  clearInterval(timerId)
  timerId = null
}

start.addEventListener("click", async ()=>{
  const result = drawGacha(gachaTable);
  audio_amountfix.currentTime = 0; 
  audio_amountfix.load();
  await animate(result);
  audio_amountfix.currentTime = 0; 
  audio_amountfix.play();
});
</script>
</body>
</html>
